<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comandas Digitais - Boteco do Zé</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@500;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --background: rgb(109, 48, 48);
            --text: #333;
            --comanda-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --input-bg: #fafafa;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --socio-bg: #ff3333;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            --background: #333;
            --text: #fff;
            --comanda-bg: #444;
            --sidebar-bg: #2c2c2c;
            --input-bg: #3c3c3c;
            --border-color: #555;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --socio-bg: #cc0000;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            width: calc(100% - 290px);
            margin-left: 290px;
            margin-top: 50px;
        }

        .title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 54px;
            color: #fff;
            letter-spacing: 0.05em;
        }

        .logo {
            width: 65px;
            height: auto;
            filter: brightness(0) invert(1);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100%;
            background: var(--sidebar-bg);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 2px 0 15px var(--shadow-color);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: background 0.3s;
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .sidebar-bottom {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .clock {
            font-size: 40px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--text);
            text-align: center;
            letter-spacing: 0.15em;
        }

        .search-bar {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            background: var(--input-bg);
            color: var(--text);
            transition: border-color 0.3s;
        }

        .search-bar:focus {
            border-color: #888;
            outline: none;
        }

        .total-debt {
            font-size: 16px;
            font-weight: 700;
            color: #d32f2f;
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }

        #addComanda {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 400;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        #addComanda:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        #addProduto, #deleteProduto {
            background: none;
            border: 1px solid #d32f2f;
            color: #d32f2f;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }

        #addProduto:hover, #deleteProduto:hover {
            background: #d32f2f;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn {
            background: none;
            border: none;
            color: #d32f2f;
            font-size: 16px;
            font-weight: 400;
            text-align: left;
            cursor: pointer;
            transition: font-size 0.2s, font-weight 0.2s;
        }

        .nav-btn:hover {
            text-decoration: underline;
            font-size: 17px;
            font-weight: 600;
        }

        .nav-btn.active {
            font-weight: 700;
            text-decoration: underline;
        }

        .container {
            width: calc(100% - 290px);
            max-width: 1920px;
            margin: 100px 0 20px 290px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            flex-grow: 1;
            padding-bottom: 50px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .row {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1920px;
            margin-bottom: 30px;
        }

        .row:last-child {
            margin-bottom: 0;
        }

        .comanda {
            background: var(--comanda-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 15px var(--shadow-color);
            width: calc(25% - 20px);
            max-width: 600px;
            min-width: 300px;
            height: 600px;
            transition: background-color 0.3s, transform 0.2s, height 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
            display: flex;
            flex-direction: column;
            position: relative;
            box-sizing: border-box;
        }

        .comanda.expanded {
            height: 1000px;
        }

        .comanda.socio-active {
            background-color: var(--socio-bg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid #ffffff;
            position: relative;
        }

        .comanda.socio-active::after {
            content: '\f4fc';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ffffff;
            color: var(--socio-bg);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .comanda.socio-active .comanda-header {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .comanda.socio-active .comanda-header input,
        .comanda.socio-active .comanda-header label {
            color: #ffffff;
        }

        .comanda.socio-active th,
        .comanda.socio-active td,
        .comanda.socio-active .total,
        .comanda.socio-active .socio-checkbox label {
            color: #ffffff;
        }

        .comanda.socio-active tr.item:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .comanda.socio-active tr.item:nth-child(odd) {
            background-color: transparent;
        }

        .comanda:hover { transform: translateY(-2px); }

        .comanda-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: #f5f5f5;
            color: var(--text);
            padding: 10px;
            margin: -25px -25px 25px -25px;
            border-radius: 12px 12px 0 0;
            font-weight: 400;
            flex-shrink: 0;
        }

        .comanda-header-left {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 5px;
            flex-grow: 1;
        }

        .comanda-header label {
            font-size: 22px;
            letter-spacing: 0.03em;
        }

        .comanda-header input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text);
            width: 100%;
            max-width: 200px;
            flex-shrink: 0;
        }

        .socio-checkbox {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 14px;
            color: var(--text);
            margin-right: 10px;
        }

        .socio-checkbox input {
            cursor: pointer;
            margin: 0;
        }

        .remove-btn {
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 12px;
            line-height: 22px;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.2s;
            display: inline-block;
        }

        .remove-btn:hover {
            transform: scale(1.1);
            background: #ff3333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            table-layout: fixed;
            flex-grow: 1;
        }

        th, td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            color: var(--text);
            font-size: 16px;
        }

        th {
            background: #fafafa;
            color: var(--text);
            font-weight: 400;
            letter-spacing: 0.05em;
            padding-bottom: 15px;
        }

        td:first-child {
            text-align: left;
            width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td:nth-child(2) { width: 20%; }
        td:nth-child(3) { width: 20%; }

        tr.item:nth-child(even) { background-color: #f9f9f9; }
        tr.item:nth-child(odd) { background-color: var(--comanda-bg); }

        .item {
            transition: opacity 0.3s ease;
        }

        .item.hidden {
            opacity: 0;
            display: none;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: auto;
            padding-top: 10px;
            flex-shrink: 0;
        }

        .buttons {
            display: flex;
            gap: 5px;
            flex: 1;
            align-items: center;
        }

        .socio-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .total {
            font-weight: 700;
            font-size: 16px;
            color: var(--text);
            margin-left: auto;
        }

        input[type="number"] {
            width: 50px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text);
        }

        .expand-btn, .popup-btn {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .expand-btn:hover, .popup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .expand-btn:active, .popup-btn:active {
            transform: scale(0.95);
        }

        .expand-btn i, .popup-btn i {
            margin: 0;
            font-size: 1rem;
        }

        .popup-btn.hidden {
            display: none;
        }

        .empty-message {
            color: var(--text);
            font-size: 18px;
            font-weight: 300;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 300;
        }

        .toast.show { opacity: 1; }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .popup-overlay.active {
            display: flex;
        }

        .popup {
            background: var(--comanda-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px var(--shadow-color);
            width: 650px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .popup-overlay.active .popup {
            transform: scale(1);
            opacity: 1;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Poppins', sans-serif;
            font-size: 26px;
            font-weight: 600;
            color: var(--text);
            padding-bottom: 10px;
            border-bottom: 2px solid #d32f2f;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #d32f2f;
            transition: transform 0.2s;
        }

        .close-btn:hover {
            color: #b71c1c;
            transform: scale(1.1);
        }

        .popup-content {
            margin-top: 10px;
        }

        .popup-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .popup-table th, .popup-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text);
        }

        .popup-table th {
            background: #d32f2f;
            color: white;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .popup-table tr:last-child td {
            border-bottom: none;
        }

        .popup-table tr:nth-child(even) {
            background: #f4f4f4;
        }

        .popup-total {
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: #d32f2f;
            text-align: right;
            padding: 15px 0;
            border-top: 2px solid var(--border-color);
            margin-top: 10px;
        }

        .share-btn {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .share-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .share-btn i {
            margin: 0;
            font-size: 1rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: var(--comanda-bg);
            border-radius: 12px;
            box-shadow: 0 3px 15px var(--shadow-color);
            padding: 15px;
        }

        .history-table th, .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text);
        }

        .history-table th {
            background: #fafafa;
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1440px) {
            .comanda {
                width: calc(33.33% - 20px);
                min-width: 300px;
                max-width: 450px;
            }
            .container, .header {
                width: calc(100% - 260px);
                margin-left: 260px;
            }
            .sidebar {
                width: 240px;
            }
            .title {
                font-size: 48px;
            }
            .logo {
                width: 60px;
            }
        }

        @media (max-width: 1280px) {
            .comanda {
                width: calc(50% - 20px);
                min-width: 280px;
                max-width: 400px;
            }
            .container, .header {
                width: calc(100% - 240px);
                margin-left: 240px;
            }
            .sidebar {
                width: 220px;
            }
            .title {
                font-size: 42px;
            }
            .logo {
                width: 55px;
            }
            .comanda-header input {
                max-width: 150px;
            }
        }

        @media (max-width: 600px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                box-shadow: none;
                border-bottom: 1px solid var(--border-color);
            }
            .header, .container {
                width: 100%;
                margin-left: 0;
                padding: 15px;
            }
            .comanda {
                width: 100%;
                max-width: 100%;
                min-width: 0;
                height: 350px;
            }
            .comanda.expanded {
                height: 800px;
            }
            .row {
                flex-wrap: wrap;
                gap: 20px;
                margin-bottom: 20px;
            }
            .row:last-child {
                margin-bottom: 0;
            }
            .container {
                padding-bottom: 30px;
            }
            .title {
                font-size: 36px;
            }
            .logo {
                width: 50px;
            }
            .header {
                margin-top: 20px;
            }
            .container {
                margin-top: 40px;
            }
            .popup {
                width: 90%;
                padding: 20px;
            }
            .popup-header {
                font-size: 20px;
            }
            .popup-table {
                font-size: 13px;
            }
            .popup-table th, .popup-table td {
                padding: 8px;
            }
            .popup-total {
                font-size: 16px;
            }
            .share-btn, .expand-btn, .popup-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            .comanda-header input {
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-top">
            <span class="clock" id="clock"></span>
            <input type="text" class="search-bar" id="searchBar" placeholder="Pesquisar comandas...">
            <span class="total-debt" id="totalDebt">Total na rua: R$ 0,00</span>
            <button id="addComanda">Adicionar Comanda</button>
            <button id="addProduto">Adicionar Produto</button>
            <button id="deleteProduto">Excluir Produto</button>
            <button id="exportCSV" class="nav-btn">Exportar CSV</button>
        </div>
        <div class="sidebar-bottom">
            <button class="nav-btn active" data-tab="comandas">Comandas</button>
            <button class="nav-btn" data-tab="historico">Histórico</button>
            <button class="nav-btn" data-tab="fluxo">Fluxo de Caixa</button>
            <button class="nav-btn" data-tab="estoque">Estoque</button>
            <button class="nav-btn" id="toggleTheme">Alternar Tema</button>
        </div>
    </div>
    <div class="header">
        <img src="imagens/bangu.png" alt="Logo Boteco do Zé" class="logo">
        <div class="title">Boteco do Zé</div>
    </div>
    <div class="container" id="container">
        <div id="comandas" class="tab-content active">
            <div id="openComandas"></div>
            <div class="empty-message" id="emptyMessage">Nenhuma comanda adicionada</div>
        </div>
        <div id="historico" class="tab-content">
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Total</th>
                        <th>Data de Fechamento</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        <div id="fluxo" class="tab-content">
            <div class="empty-message">Funcionalidade de Fluxo de Caixa em desenvolvimento</div>
        </div>
        <div id="estoque" class="tab-content">
            <div class="empty-message">Funcionalidade de Estoque em desenvolvimento</div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <div class="popup-overlay" id="popupOverlay" role="dialog" aria-labelledby="popupTitle">
        <div class="popup" id="popup">
            <div class="popup-header">
                <span id="popupTitle">Detalhes da Comanda</span>
                <button class="close-btn" onclick="closePopup()" aria-label="Fechar">×</button>
            </div>
            <div class="popup-content" id="popupContent">
                <table class="popup-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Preço</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="popupTableBody"></tbody>
                </table>
            </div>
            <div class="popup-total" id="popupTotal">Total: R$ 0,00</div>
            <button class="share-btn" title="Compartilhar Comanda como PDF"><i class="fab fa-whatsapp"></i></button>
        </div>
    </div>

    <div id="qrcode" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let produtos = JSON.parse(localStorage.getItem('produtos')) || [
            { nome: 'Heineken', preco: 18, icon: 'fas fa-beer-mug-empty' },
            { nome: 'Original', preco: 15, icon: 'fas fa-beer-mug-empty' },
            { nome: 'Brahma', preco: 12, icon: 'fas fa-beer-mug-empty' },
            { nome: 'Água', preco: 3, icon: 'fas fa-glass-water' },
            { nome: 'Refrigerante lata', preco: 3, icon: 'fas fa-can-cola' },
            { nome: 'Refrigerante 2L', preco: 5, icon: 'fas fa-bottle-water' },
            { nome: 'Gatorade', preco: 15, icon: 'fas fa-bottle-water' },
            { nome: 'Pastel', preco: 9, icon: 'fas fa-bread-slice' },
            { nome: 'Batata (300g)', preco: 15, icon: 'fas fa-bacon' }
        ];

        const DOM = {
            sidebar: document.getElementById('sidebar'),
            clock: document.getElementById('clock'),
            searchBar: document.getElementById('searchBar'),
            totalDebt: document.getElementById('totalDebt'),
            addComanda: document.getElementById('addComanda'),
            addProduto: document.getElementById('addProduto'),
            deleteProduto: document.getElementById('deleteProduto'),
            exportCSV: document.getElementById('exportCSV'),
            emptyMessage: document.getElementById('emptyMessage'),
            openComandas: document.getElementById('openComandas'),
            toast: document.getElementById('toast'),
            container: document.getElementById('container'),
            popupOverlay: document.getElementById('popupOverlay'),
            popup: document.getElementById('popup'),
            popupTitle: document.getElementById('popupTitle'),
            popupContent: document.getElementById('popupContent'),
            popupTableBody: document.getElementById('popupTableBody'),
            popupTotal: document.getElementById('popupTotal'),
            toggleTheme: document.getElementById('toggleTheme'),
            historyBody: document.getElementById('historyBody')
        };

        const formatCurrency = value => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        const updateClock = () => DOM.clock.innerText = new Date().toLocaleTimeString('pt-BR', { hour12: false });

        const showToast = (message) => {
            DOM.toast.innerText = message;
            DOM.toast.classList.add('show');
            setTimeout(() => DOM.toast.classList.remove('show'), 2000);
        };

        const updateTotalDebt = () => {
            const totalDebt = Array.from(document.querySelectorAll('.comanda .total'))
                .reduce((sum, el) => sum + (parseFloat(el.innerText.replace(/[^\d,.]/g, '').replace(',', '.')) || 0), 0);
            DOM.totalDebt.innerText = `Total na rua: ${formatCurrency(totalDebt)}`;
        };

        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        };

        const atualizarTotal = debounce((comandaId) => {
            const comanda = document.getElementById(`comanda-${comandaId}`);
            if (!comanda) return;
            const quantidades = comanda.querySelectorAll('.quantidade');
            const totais = comanda.querySelectorAll('.preco-total');
            const items = comanda.querySelectorAll('.item');
            let total = 0;

            quantidades.forEach((input, i) => {
                let qty = Math.max(0, parseInt(input.value) || 0);
                if (qty < 0) showToast('Quantidade negativa ajustada para 0');
                input.value = qty;
                const subtotal = qty * produtos[i].preco;
                totais[i].innerText = formatCurrency(subtotal);
                total += subtotal;
            });

            const isExpanded = comanda.classList.contains('expanded');
            items.forEach((item, i) => {
                item.classList.toggle('hidden', !isExpanded && i >= 4);
            });

            document.getElementById(`total-${comandaId}`).innerText = `Total: ${formatCurrency(total)}`;
            if (DOM.popupOverlay.classList.contains('active')) {
                DOM.popupTotal.innerText = `Total: ${formatCurrency(total)}`;
            }
            const popupBtn = document.getElementById(`popupBtn-${comandaId}`);
            popupBtn.classList.toggle('hidden', total === 0);
            salvarComandas();
            updateTotalDebt();
        }, 300);

        const toggleExpand = (comandaId) => {
            const comanda = document.getElementById(`comanda-${comandaId}`);
            if (!comanda) return;
            const expandBtn = document.getElementById(`expandBtn-${comandaId}`);
            comanda.classList.toggle('expanded');
            expandBtn.querySelector('i').className = comanda.classList.contains('expanded') ? 'fas fa-compress' : 'fas fa-expand';
            const items = comanda.querySelectorAll('.item');
            items.forEach((item, i) => {
                if (comanda.classList.contains('expanded')) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.toggle('hidden', i >= 4);
                }
            });
            atualizarTotal(comandaId);
        };

        const togglePopup = (comandaId) => {
            const comanda = document.getElementById(`comanda-${comandaId}`);
            if (!comanda) return;
            const customerName = comanda.querySelector(`#customerName-${comandaId}`).value || 'Cliente';
            const quantidades = Array.from(comanda.querySelectorAll('.quantidade')).map(input => input.value);

            if (!DOM.popupOverlay.classList.contains('active')) {
                DOM.popupTitle.innerText = `Detalhes da Comanda - ${customerName}`;
                DOM.popupTableBody.innerHTML = produtos.map((p, i) => {
                    const qty = parseInt(quantidades[i]) || 0;
                    if (qty === 0) return '';
                    const subtotal = qty * p.preco;
                    return `
                        <tr>
                            <td>${p.nome}</td>
                            <td>${formatCurrency(p.preco)}</td>
                            <td>${qty}</td>
                            <td>${formatCurrency(subtotal)}</td>
                        </tr>
                    `;
                }).join('');
                DOM.popupOverlay.classList.add('active');
                atualizarTotal(comandaId);

                const shareBtn = DOM.popup.querySelector('.share-btn');
                shareBtn.onclick = () => shareComanda(comandaId);
            } else {
                closePopup();
            }
        };

        const closePopup = () => {
            DOM.popupOverlay.classList.remove('active');
        };

        const shareComanda = async (comandaId) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');

            let logoAdded = false;
            try {
                const logoUrl = 'imagens/bangu-tavares.png';
                const logoImg = new Image();
                logoImg.crossOrigin = "Anonymous";
                logoImg.src = logoUrl;

                await new Promise((resolve, reject) => {
                    logoImg.onload = () => {
                        doc.setFillColor(255, 255, 255);
                        doc.rect(10, 10, 30, 30, 'F');
                        doc.addImage(logoImg, 'PNG', 10, 10, 30, 30);
                        logoAdded = true;
                        resolve();
                    };
                    logoImg.onerror = () => {
                        console.error('Erro ao carregar o logo "bangu-tavares.png".');
                        showToast('Erro ao carregar o logo. PDF gerado sem logo.');
                        resolve();
                    };
                });
            } catch (error) {
                console.error('Erro ao processar o logo:', error);
            }

            doc.setFontSize(36);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Boteco do Zé', logoAdded ? 45 : 10, 30);

            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 0, 0);
            doc.line(10, 45, 200, 45);

            const closeBtn = DOM.popup.querySelector('.close-btn');
            const shareBtn = DOM.popup.querySelector('.share-btn');
            if (closeBtn) closeBtn.style.display = 'none';
            if (shareBtn) shareBtn.style.display = 'none';

            let popupHeight = 0;
            try {
                const popupContent = DOM.popup;
                const canvas = await html2canvas(popupContent, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                popupHeight = (canvas.height * imgWidth) / canvas.width;
                doc.addImage(imgData, 'PNG', 10, 55, imgWidth, popupHeight);
            } catch (error) {
                console.error('Erro ao capturar o pop-up:', error);
                showToast('Erro ao capturar o conteúdo do pop-up.');
            }

            if (closeBtn) closeBtn.style.display = 'block';
            if (shareBtn) shareBtn.style.display = 'flex';

            const pixMessageY = 55 + popupHeight + 20;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text('Pague via Pix para Boteco do Zé:', 10, pixMessageY);
            doc.setFontSize(12);
            doc.text('Chave Pix: (21) 98765-4321', 10, pixMessageY + 10);

            const pixKey = '(21) 98765-4321';
            const pixLink = `https://pix.bcb.gov.br/${encodeURIComponent(pixKey)}`;
            const qrCodeDiv = document.getElementById('qrcode');
            qrCodeDiv.innerHTML = '';
            new QRCode(qrCodeDiv, {
                text: pixLink,
                width: 100,
                height: 100,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            try {
                const qrCanvas = qrCodeDiv.querySelector('canvas');
                const qrImgData = qrCanvas.toDataURL('image/png');
                doc.addImage(qrImgData, 'PNG', 150, pixMessageY - 10, 40, 40);
            } catch (error) {
                console.error('Erro ao capturar o QR Code:', error);
                showToast('Erro ao gerar o QR Code para o Pix.');
            }

            try {
                const pdfBlob = doc.output('blob');
                const url = window.URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `comanda_${comandaId}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('PDF da comanda gerado e baixado!');
            } catch (error) {
                console.error('Erro ao salvar o PDF:', error);
                showToast('Erro ao salvar o PDF.');
            }
        };

        const removeComanda = (id) => {
            const comanda = document.getElementById(`comanda-${id}`);
            const isSocio = comanda.querySelector(`#socio-${id}`).checked;
            const quantidades = Array.from(comanda.querySelectorAll('.quantidade')).map(input => parseInt(input.value) || 0);
            const items = produtos.map((p, i) => ({
                nome: p.nome,
                preco: p.preco,
                quantidade: quantidades[i]
            })).filter(item => item.quantidade > 0);

            if (isSocio) {
                const closedComandas = JSON.parse(localStorage.getItem('closedComandas')) || [];
                closedComandas.push({
                    id,
                    nome: comanda.querySelector(`#customerName-${id}`).value,
                    total: comanda.querySelector(`.total`).innerText,
                    items: items,
                    closedAt: new Date().toLocaleString('pt-BR')
                });
                localStorage.setItem('closedComandas', JSON.stringify(closedComandas));
                loadHistory();
            }

            comanda.remove();
            reorganizarComandas();
            salvarComandas();
            updateTotalDebt();
            showToast('Comanda fechada!');
        };

        const createComanda = (id) => {
            const comanda = document.createElement('div');
            comanda.className = 'comanda';
            comanda.id = `comanda-${id}`;
            comanda.innerHTML = `
                <div class="comanda-header">
                    <div class="comanda-header-left">
                        <label for="customerName-${id}">Nome:</label>
                        <input type="text" id="customerName-${id}" placeholder="Digite o nome do cliente">
                    </div>
                    <button class="remove-btn" onclick="removeComanda(${id})" aria-label="Remover Comanda">X</button>
                </div>
                <table>
                    <tr><th scope="col">Produto</th><th scope="col">Qtd</th><th scope="col">Total</th></tr>
                    ${produtos.map((p, i) => `
                        <tr class="item${i >= 4 ? ' hidden' : ''}">
                            <td title="Preço: ${formatCurrency(p.preco)}">${p.nome}</td>
                            <td><input type="number" class="quantidade" min="0" value="0"></td>
                            <td class="preco-total">R$ 0,00</td>
                        </tr>
                    `).join('')}
                </table>
                <div class="footer">
                    <div class="buttons">
                        <button id="expandBtn-${id}" class="expand-btn" title="Expandir Comanda" tabindex="0"><i class="fas fa-expand"></i></button>
                        <button id="popupBtn-${id}" class="popup-btn hidden" title="Ver Detalhes (Pop-up)" tabindex="0"><i class="fas fa-external-link-alt"></i></button>
                    </div>
                    <div class="socio-container">
                        <div class="socio-checkbox">
                            <input type="checkbox" id="socio-${id}">
                            <label for="socio-${id}" style="margin-left: 2px;">Sócio</label>
                        </div>
                        <div class="total" id="total-${id}">Total: R$ 0,00</div>
                    </div>
                </div>
            `;

            const expandBtn = comanda.querySelector(`#expandBtn-${id}`);
            const popupBtn = comanda.querySelector(`#popupBtn-${id}`);
            const socioCheckbox = comanda.querySelector(`#socio-${id}`);
            expandBtn.addEventListener('click', () => toggleExpand(id));
            popupBtn.addEventListener('click', () => togglePopup(id));
            socioCheckbox.addEventListener('change', () => updateSocioStatus(id));
            expandBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleExpand(id);
                }
            });
            popupBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    togglePopup(id);
                }
            });

            comanda.querySelectorAll('.quantidade').forEach(input => input.addEventListener('input', () => atualizarTotal(id)));
            comanda.querySelector(`#customerName-${id}`).addEventListener('input', salvarComandas);
            return comanda;
        };

        const updateSocioStatus = (comandaId) => {
            const comanda = document.getElementById(`comanda-${comandaId}`);
            const isSocio = comanda.querySelector(`#socio-${comandaId}`).checked;
            comanda.classList.toggle('socio-active', isSocio);
            salvarComandas();
        };

        const getOrCreateRow = (index, container) => {
            const rowId = `row${index + 1}`;
            let row = container.querySelector(`#${rowId}`);
            if (!row) {
                row = document.createElement('div');
                row.className = 'row';
                row.id = rowId;
                container.appendChild(row);
            }
            return row;
        };

        const reorganizarComandas = () => {
            const openComandas = Array.from(document.querySelectorAll('.comanda'));
            const sortBy = 'total-desc';
            openComandas.sort((a, b) => {
                if (sortBy === 'total-desc') {
                    const totalA = parseFloat(a.querySelector('.total').innerText.replace(/[^\d,.]/g, '').replace(',', '.')) || 0;
                    const totalB = parseFloat(b.querySelector('.total').innerText.replace(/[^\d,.]/g, '').replace(',', '.')) || 0;
                    return totalB - totalA;
                } else if (sortBy === 'name-asc') {
                    const nameA = a.querySelector('input[type="text"]').value.toLowerCase();
                    const nameB = b.querySelector('input[type="text"]').value.toLowerCase();
                    return nameA.localeCompare(nameB);
                }
                return 0;
            });
            DOM.openComandas.innerHTML = '';
            openComandas.forEach((comanda, index) => {
                const rowIndex = Math.floor(index / 4);
                const row = getOrCreateRow(rowIndex, DOM.openComandas);
                row.appendChild(comanda);
            });
        };

        const salvarComandas = () => {
            const comandas = {};
            document.querySelectorAll('.comanda').forEach(c => {
                const id = c.id.split('-')[1];
                comandas[id] = {
                    nome: document.getElementById(`customerName-${id}`).value,
                    quantidades: Array.from(c.querySelectorAll('.quantidade')).map(i => i.value),
                    isSocio: document.getElementById(`socio-${id}`).checked,
                    expanded: c.classList.contains('expanded'),
                    createdAt: comandas[id]?.createdAt || new Date().toISOString()
                };
            });
            localStorage.setItem('comandas', JSON.stringify(comandas));
        };

        const carregarComandas = () => {
            const saved = JSON.parse(localStorage.getItem('comandas')) || {};
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const comanda = entry.target;
                        comanda.style.opacity = 1;
                        observer.unobserve(comanda);
                    }
                });
            }, { threshold: 0.1 });

            Object.entries(saved).forEach(([id, data]) => {
                const comanda = createComanda(id);
                comanda.style.opacity = 0;
                const todasComandas = DOM.openComandas.querySelectorAll('.comanda').length;
                const rowIndex = Math.floor(todasComandas / 4);
                const row = getOrCreateRow(rowIndex, DOM.openComandas);
                row.appendChild(comanda);
                document.getElementById(`customerName-${id}`).value = data.nome;
                document.getElementById(`socio-${id}`).checked = data.isSocio || false;
                if (data.isSocio) comanda.classList.add('socio-active');
                const inputs = comanda.querySelectorAll('.quantidade');
                data.quantidades.forEach((qty, i) => i < inputs.length && (inputs[i].value = qty));
                if (data.expanded) toggleExpand(id);
                observer.observe(comanda);
                atualizarTotal(id);
            });
            reorganizarComandas();
        };

        const loadHistory = () => {
            const closedComandas = JSON.parse(localStorage.getItem('closedComandas')) || [];
            DOM.historyBody.innerHTML = closedComandas.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.nome || 'Sem Nome'}</td>
                    <td>${c.total}</td>
                    <td>${c.closedAt}</td>
                </tr>
            `).join('');
        };

        const toggleSidebarAndMessage = () => {
            const comandasCount = document.querySelectorAll('.comanda').length;
            DOM.emptyMessage.style.display = comandasCount ? 'none' : 'block';
        };

        const filterComandas = () => {
            const searchValue = DOM.searchBar.value.toLowerCase();
            document.querySelectorAll('.comanda').forEach(c => {
                const nome = c.querySelector('input[type="text"]').value.toLowerCase();
                c.style.display = nome.includes(searchValue) ? 'block' : 'none';
            });
            reorganizarComandas();
        };

        const addProduto = () => {
            const nome = prompt('Nome do produto:');
            const preco = parseFloat(prompt('Preço do produto (em R$):'));
            const icon = prompt('Ícone (ex.: fa-beer-mug-empty, fa-glass-water, fa-bacon):') || 'fa-box';
            if (nome && !isNaN(preco) && preco > 0) {
                produtos.push({ nome, preco, icon });
                localStorage.setItem('produtos', JSON.stringify(produtos));
                recarregarComandas();
                showToast(`Produto ${nome} adicionado!`);
            } else {
                showToast('Nome ou preço inválido!');
            }
        };

        const deleteProduto = () => {
            const nome = prompt('Digite o nome do produto a excluir:');
            const index = produtos.findIndex(p => p.nome.toLowerCase() === nome.toLowerCase());
            if (index === -1) {
                showToast('Produto não encontrado!');
                return;
            }
            const comandas = JSON.parse(localStorage.getItem('comandas')) || {};
            const isInUse = Object.values(comandas).some(c => parseInt(c.quantidades[index]) > 0);
            if (isInUse) {
                showToast('Não pode excluir: produto em uso em comanda!');
                return;
            }
            produtos.splice(index, 1);
            localStorage.setItem('produtos', JSON.stringify(produtos));
            Object.values(comandas).forEach(c => c.quantidades.splice(index, 1));
            localStorage.setItem('comandas', JSON.stringify(comandas));
            recarregarComandas();
            showToast(`Produto ${nome} excluído!`);
        };

        const recarregarComandas = () => {
            DOM.openComandas.innerHTML = '';
            carregarComandas();
        };

        const exportToCSV = () => {
            const comandas = JSON.parse(localStorage.getItem('comandas')) || {};
            const csv = ['ID,Nome,Data de Criação,Total,Itens'];
            Object.entries(comandas).forEach(([id, data]) => {
                const comanda = document.getElementById(`comanda-${id}`);
                if (!comanda) return;
                const total = Array.from(comanda.querySelectorAll('.preco-total'))
                    .reduce((sum, el) => sum + (parseFloat(el.innerText.replace(/[^\d,.]/g, '').replace(',', '.')) || 0), 0);
                const quantidades = data.quantidades;
                const items = produtos.map((p, i) => ({
                    nome: p.nome,
                    preco: p.preco,
                    quantidade: quantidades[i]
                })).filter(item => parseInt(item.quantidade) > 0);
                const itemsStr = items.map(item => `${item.nome} (${formatCurrency(item.preco)}) x ${item.quantidade}`).join('; ');
                const createdAt = new Date(data.createdAt).toLocaleString('pt-BR');
                csv.push(`${id},${data.nome || 'Sem Nome'},${createdAt},${formatCurrency(total)},${itemsStr || 'Nenhum item'}`);
            });
            const csvData = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(csvData);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'comandas.csv');
            a.click();
        };

        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-btn[data-tab="${tabId}"]`).classList.add('active');
            if (tabId === 'comandas') {
                DOM.searchBar.style.display = 'block';
                DOM.totalDebt.style.display = 'block';
                DOM.addComanda.style.display = 'block';
                DOM.addProduto.style.display = 'block';
                DOM.deleteProduto.style.display = 'block';
                DOM.exportCSV.style.display = 'block';
            } else {
                DOM.searchBar.style.display = 'none';
                DOM.totalDebt.style.display = 'none';
                DOM.addComanda.style.display = 'none';
                DOM.addProduto.style.display = 'none';
                DOM.deleteProduto.style.display = 'none';
                DOM.exportCSV.style.display = 'none';
            }
        };

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            carregarComandas();
            loadHistory();
            toggleSidebarAndMessage();
            updateTotalDebt();
            setInterval(updateClock, 1000);
            updateClock();
            if (!navigator.onLine) showToast('Sistema offline');

            DOM.addComanda.addEventListener('click', () => {
                console.log('Botão Adicionar Comanda clicado'); // Log para depuração
                const newId = Date.now();
                const todasComandas = DOM.openComandas.querySelectorAll('.comanda').length;
                const rowIndex = Math.floor(todasComandas / 4);
                const row = getOrCreateRow(rowIndex, DOM.openComandas);
                row.appendChild(createComanda(newId));
                atualizarTotal(newId);
                reorganizarComandas();
                toggleSidebarAndMessage();
                showToast('Comanda adicionada!');
            });

            DOM.addProduto.addEventListener('click', addProduto);
            DOM.deleteProduto.addEventListener('click', deleteProduto);
            DOM.searchBar.addEventListener('input', debounce(filterComandas, 300));
            DOM.exportCSV.addEventListener('click', exportToCSV);
            DOM.toggleTheme.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        };
    </script>
</body>
</html>